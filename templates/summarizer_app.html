<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majima AI App</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            svg: { fontCache: 'none' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script" async></script>

    <style>
        /* --- APP SPECIFIC STYLES --- */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .subject-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .subject-card:hover {
            border-color: var(--primary-red);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(229, 9, 20, 0.15);
        }

        .subject-card h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .subject-card i {
            font-size: 2rem;
            color: var(--primary-red);
            margin-bottom: 15px;
            display: block;
        }

        /* Lecture List (Accordion) */
        .lecture-list-container {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 30px;
            display: none;
            /* Hidden by default until subject clicked */
        }

        .lecture-list-container.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .lecture-list-header {
            padding: 15px 20px;
            background-color: #1a1a1a;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-muted);
        }

        .lecture-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .lecture-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .lecture-item:last-child {
            border-bottom: none;
        }

        .lecture-item:hover {
            background-color: var(--surface-hover);
        }

        .lecture-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1.05rem;
        }

        .lecture-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Summary Panel (Paper View) */
        #summary-panel-printable {
            display: none;
            margin-top: 40px;
            animation: fadeIn 0.5s ease;
        }

        .paper-view {
            background-color: #1a1a1a;
            /* Slightly lighter than bg for contrast */
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            margin: 0 auto;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-content {
            font-family: 'Georgia', serif;
            /* Serif for better reading experience */
            font-size: 1.1rem;
            line-height: 1.8;
            color: #e0e0e0;
            text-align: left;
            /* Default to left for English */
            direction: ltr;
            /* Default to left-to-right */
        }

        .summary-content[dir="rtl"] {
            text-align: right;
            direction: rtl;
        }

        .summary-content[dir="ltr"] {
            text-align: left;
            direction: ltr;
        }

        .summary-content h1,
        .summary-content h2,
        .summary-content h3 {
            font-family: 'Segoe UI', sans-serif;
            color: var(--primary-red);
            margin-top: 1.5em;
        }

        .summary-content code {
            background-color: #333;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            color: #ff8a8f;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-box {
            background: var(--surface-color);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            animation: scaleIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .tier-card {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tier-card:hover {
            border-color: var(--text-muted);
        }

        .tier-card.selected {
            border-color: var(--primary-red);
            background-color: rgba(229, 9, 20, 0.05);
        }

        .tier-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tier-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: var(--text-muted);
        }

        .tier-card.selected .tier-icon {
            color: var(--primary-red);
        }

        /* Print Overrides */
        @media print {
            body * {
                visibility: hidden;
            }

            #summary-panel-printable,
            #summary-panel-printable * {
                visibility: visible !important;
            }

            html,
            body,
            .summary-content,
            #summary-content-area {
                overflow: visible !important;
                height: auto !important;
                width: auto !important;
            }

            #summary-panel-printable {
                display: block !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background: none !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            /* Remove box/border and shadow */
            .paper-view {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Hide Header (Subject/Title) */
            .summary-header {
                display: none !important;
            }

            .summary-content {
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background-color: #fff !important;
                color: #000 !important;
                white-space: normal !important;
            }

            .no-print {
                display: none !important;
            }

            .summary-content * {
                color: #000 !important;
                background-color: #fff !important;
            }

            /* Watermark: Centered, Red, Middle of Page */
            .watermark {
                display: block !important;
                position: fixed;
                /* Fixed to viewport */
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3rem;
                /* Larger for center */
                color: rgba(229, 9, 20, 0.2) !important;
                /* Red with opacity */
                font-weight: bold;
                text-transform: uppercase;
                z-index: 9999;
                pointer-events: none;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>
    <div class="user-layout">
        <!-- HEADER -->
        <header class="user-header no-print">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="Logo"
                    style="width: 40px; height: 40px;">
                <div>
                    <h1 style="margin:0; font-size: 1.5rem;">Majima AI</h1>
                    <small class="text-muted">Welcome, {{ session.username }}</small>
                </div>
            </div>
            <div>
                {% if session.role == 'admin' %}
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-primary" style="margin-right: 10px;">
                    <i class="fa-solid fa-shield-halved"></i> Admin Panel
                </a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
        </header>

        <!-- FLASH MESSAGES -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert-box {{ category }} no-print">
            <div class="alert-icon">
                {% if category == 'success' %}
                <i class="fa-solid fa-circle-check" style="color: var(--success-color); font-size: 1.5rem;"></i>
                {% else %}
                <i class="fa-solid fa-circle-exclamation" style="color: var(--error-color); font-size: 1.5rem;"></i>
                {% endif %}
            </div>
            <div class="alert-content">
                <div class="alert-title">
                    {% if category == 'success' %}Success{% else %}Error{% endif %}
                </div>
                <div class="alert-message">{{ message }}</div>
            </div>
            <button class="alert-close" onclick="this.parentElement.remove()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- SUBJECT GRID -->
        <h2 class="no-print">Select a Subject</h2>
        {% if subjects_data %}
        <div class="subject-grid no-print">
            {% for subject in subjects_data %}
            <div class="subject-card" onclick="toggleLectures('lectures-{{ subject.id }}')">
                <i class="fa-solid fa-book-open"></i>
                <h3>{{ subject.name }}</h3>
                <p class="text-muted" style="margin-top: 5px; font-size: 0.9rem;">
                    {{ subject.lectures|length }} Lectures
                </p>
            </div>
            {% endfor %}
        </div>

        <!-- LECTURE LISTS (Hidden by default) -->
        <div id="lecture-list-wrapper" class="no-print">
            {% for subject in subjects_data %}
            <div id="lectures-{{ subject.id }}" class="lecture-list-container">
                <div class="lecture-list-header">
                    <i class="fa-solid fa-list"></i> Lectures for {{ subject.name }}
                </div>
                <ul class="lecture-list">
                    {% if subject.lectures %}
                    {% for lecture in subject.lectures %}
                    <li class="lecture-item"
                        onclick="showSummaryPanel('{{ lecture.lecture_id }}', '{{ lecture.title | e }}', '{{ subject.name | e }}')">
                        <div>
                            <div class="lecture-title">{{ lecture.title }}</div>
                            <div class="lecture-meta">
                                <i class="fa-regular fa-file-pdf"></i> {{ lecture.original_filename }}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <a href="{{ url_for('user_view_file', filename=lecture['original_filename']) }}"
                                target="_blank" class="btn btn-secondary btn-sm" onclick="event.stopPropagation()">
                                <i class="fa-solid fa-eye"></i> View PDF
                            </a>
                            <button class="btn btn-primary btn-sm">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Summarize
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li style="padding: 20px; text-align: center; color: var(--text-muted);">
                        No lectures uploaded yet.
                    </li>
                    {% endif %}
                </ul>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert-box danger no-print">
            <div class="alert-icon"><i class="fa-solid fa-circle-exclamation"
                    style="color: var(--error-color); font-size: 1.5rem;"></i></div>
            <div class="alert-content">
                <div class="alert-title">No Content</div>
                <div class="alert-message">No subjects available. Please contact the administrator.</div>
            </div>
        </div>
        {% endif %}

        <!-- SUMMARY PANEL -->
        <div id="summary-panel-printable">
            <div class="watermark" style="display: none;"> Made by: MAJIMA-AI</div>
            <div class="paper-view">
                <div class="summary-header">
                    <div>
                        <h2 id="summary-title" style="margin-bottom: 5px;">Lecture Title</h2>
                        <p id="summary-subject" class="text-red" style="font-weight: 600;">Subject Name</p>
                    </div>
                    <div class="no-print" style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="copySummary()" title="Copy Text">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button class="btn btn-outline" onclick="printSummary()" title="Print / PDF">
                            <i class="fa-solid fa-print"></i>
                        </button>
                        <button id="regenerate-btn" class="btn btn-outline" onclick="handleSummaryGeneration(true)"
                            style="display: none;" title="Regenerate Summary">
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                    </div>
                </div>

                <div id="summary-content-area" class="summary-content" dir="auto">
                    <p class="text-muted" style="text-align: center; padding: 40px;">
                        <i class="fa-solid fa-arrow-up" style="margin-bottom: 10px; display: block;"></i>
                        Select a lecture above to generate a summary.
                    </p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; color: var(--text-muted); font-size: 0.8rem;"
                class="no-print">
                Generated by Majima AI â€¢ {{ session.username }}
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="modal-overlay">
        <div style="text-align: center; color: white;">
            <div class="spinner" style="margin: 0 auto 20px auto;"></div>
            <h3>Generating Summary...</h3>
            <p>This may take a moment.</p>
        </div>
    </div>

    <!-- LENGTH SELECTION MODAL -->
    <div id="length-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>Select Summary Length</h2>
            <p id="size-loading" class="text-muted" style="display: none;">Analyzing lecture...</p>

            <div id="options-container"
                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0;">
                <!-- JS Injects Cards Here -->
            </div>

            <button id="confirm-generate-btn" class="btn btn-primary" style="width: 100%; display: none;"
                onclick="startGeneration()">
                Start Generation
            </button>

            <button onclick="document.getElementById('length-modal').style.display='none'" class="btn btn-outline"
                style="margin-top: 15px; width: 100%; border: none;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // --- MARKED.JS CONFIG ---
        marked.setOptions({ mangle: false, headerIds: false });

        // --- DOM ELEMENTS ---
        const summaryPanel = document.getElementById('summary-panel-printable');
        const summaryTitle = document.getElementById('summary-title');
        const summarySubject = document.getElementById('summary-subject');
        const summaryContent = document.getElementById('summary-content-area');
        const overlay = document.getElementById('loading-overlay');
        let currentLectureId = null; // Store current lecture ID

        // --- TOGGLE LECTURES ---
        function toggleLectures(listId) {
            // Hide all others
            document.querySelectorAll('.lecture-list-container').forEach(el => {
                if (el.id !== listId) el.classList.remove('active');
            });

            const target = document.getElementById(listId);
            if (target) {
                target.classList.toggle('active');
                if (target.classList.contains('active')) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // --- SHOW SUMMARY PANEL ---
        function showSummaryPanel(lectureId, lectureTitle, subjectName) {
            summaryTitle.textContent = lectureTitle;
            summarySubject.textContent = subjectName;
            currentLectureId = lectureId; // Store lecture ID

            // Reset content
            summaryContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fa-solid fa-wand-magic-sparkles fa-3x text-red" style="margin-bottom: 20px;"></i>
                    <h3>Ready to Summarize</h3>
                    <p class="text-muted">Click the button below to generate a new summary.</p>
                    <button class="btn btn-primary" onclick="handleSummaryGeneration()">Generate Now</button>
                </div>
            `;

            // Hide regenerate button when no summary
            const regenerateBtn = document.getElementById('regenerate-btn');
            if (regenerateBtn) {
                regenerateBtn.style.display = 'none';
            }
            summaryContent.setAttribute('dir', 'auto');
            summaryContent.style.textAlign = '';

            summaryPanel.style.display = 'block';
            summaryPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- COPY FUNCTION ---
        async function copySummary() {
            try {
                await navigator.clipboard.writeText(summaryContent.innerText);
                alert('Summary copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }

        // --- PRINT FUNCTION ---
        async function printSummary() {
            await MathJax.typesetPromise([summaryContent]);
            window.print();
        }

        // --- GENERATION LOGIC (Kept from original) ---
        let selectedWords = null;

        let isForceRefresh = false;

        async function handleSummaryGeneration(force = false) {
            isForceRefresh = force;
            const lectureId = currentLectureId;
            if (!lectureId) return;

            const modal = document.getElementById('length-modal');
            const container = document.getElementById('options-container');
            const sizeLoading = document.getElementById('size-loading');
            modal.style.display = 'flex';
            container.innerHTML = '';
            document.getElementById('confirm-generate-btn').style.display = 'none';
            sizeLoading.style.display = 'block';

            // Fetch chunk count to determine available tiers
            let chunkCount = 0;
            try {
                const sizeResponse = await fetch(`/app/check_size/${lectureId}`);
                if (!sizeResponse.ok) {
                    console.error('Failed to fetch chunk count:', sizeResponse.status);
                } else {
                    const sizeData = await sizeResponse.json();
                    chunkCount = parseInt(sizeData.chunk_count) || 0;
                }
            } catch (e) {
                console.error('Error fetching chunk count:', e);
            }

            sizeLoading.style.display = 'none';

            const tiers = [
                { label: "Concise", words: "< 300 words ", value: 300, icon: "fa-solid fa-compress", minChunks: 0 },
                { label: "Standard", words: "< 600 words", value: 600, icon: "fa-solid fa-book-open", minChunks: 10 },
                { label: "Detailed", words: "> 600 words", value: 1000, icon: "fa-solid fa-layer-group", minChunks: 25 }
            ];

            tiers.forEach(tier => {
                const card = document.createElement('div');
                const isDisabled = chunkCount < tier.minChunks;

                if (isDisabled) {
                    card.className = 'tier-card disabled';
                    card.title = `Requires at least ${tier.minChunks} chunks (this lecture has ${chunkCount})`;
                } else {
                    card.className = 'tier-card';
                    card.onclick = () => {
                        document.querySelectorAll('.tier-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedWords = tier.value;

                        const btn = document.getElementById('confirm-generate-btn');
                        btn.style.display = 'block';
                        btn.innerHTML = `<i class="fa-solid fa-bolt"></i> Generate ${tier.label} Summary`;
                    };
                }

                card.innerHTML = `
                    <i class="${tier.icon} tier-icon"></i>
                    <div style="font-weight: bold; margin-bottom: 5px;">${tier.label}</div>
                    <div style="font-size: 0.8em; color: var(--text-muted);">${tier.words}</div>
                    ${isDisabled ? '<div style="font-size: 0.7em; color: var(--error-color); margin-top: 5px;">Not available</div>' : ''}
                `;

                container.appendChild(card);
            });
        }

        async function startGeneration() {
            document.getElementById('length-modal').style.display = 'none';
            const lectureId = currentLectureId;

            overlay.style.display = 'flex'; // Changed from block to flex for centering

            try {
                const response = await fetch(`/app/generate_summary_ajax/${lectureId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ target_words: selectedWords, force_refresh: isForceRefresh })
                });
                const data = await response.json();

                if (response.ok) {
                    const summaryText = data.summary;
                    summaryContent.innerHTML = marked.parse(summaryText);
                    await MathJax.typesetPromise([summaryContent]);

                    // Detect Arabic and set proper alignment
                    const arabicPattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
                    const hasArabic = arabicPattern.test(summaryText);

                    if (hasArabic) {
                        // Arabic: Right-to-left alignment
                        summaryContent.setAttribute('dir', 'rtl');
                        summaryContent.style.textAlign = 'right';
                        summaryContent.style.direction = 'rtl';
                    } else {
                        // English/Other: Left-to-right alignment
                        summaryContent.setAttribute('dir', 'ltr');
                        summaryContent.style.textAlign = 'left';
                        summaryContent.style.direction = 'ltr';
                    }

                    // Show regenerate button after summary is generated
                    const regenerateBtn = document.getElementById('regenerate-btn');
                    if (regenerateBtn) {
                        regenerateBtn.style.display = 'inline-flex';
                    }
                } else {
                    // Show Error Alert
                    showErrorAlert(data.error || "Unknown error occurred.");
                    summaryContent.innerHTML = `<p class="text-muted" style="text-align: center; padding: 40px;">Generation failed.</p>`;
                }
            } catch (error) {
                showErrorAlert("Network error. Please check your connection.");
                summaryContent.innerHTML = `<p class="text-muted" style="text-align: center; padding: 40px;">Generation failed.</p>`;
            } finally {
                overlay.style.display = 'none';
            }
        }

        function showErrorAlert(message) {
            const alertBox = document.createElement('div');
            alertBox.className = 'alert-box error';
            alertBox.innerHTML = `
                <div class="alert-icon"><i class="fa-solid fa-circle-exclamation" style="color: var(--error-color); font-size: 1.5rem;"></i></div>
                <div class="alert-content">
                    <div class="alert-title">Error</div>
                    <div class="alert-message">${message}</div>
                </div>
                <button class="alert-close" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>
            `;
            document.body.appendChild(alertBox);

            // Auto dismiss after 3 seconds
            setTimeout(() => {
                if (alertBox.parentElement) {
                    alertBox.style.transition = 'opacity 0.5s ease';
                    alertBox.style.opacity = '0';
                    setTimeout(() => alertBox.remove(), 500);
                }
            }, 3000);
        }

        // Auto-dismiss static flash messages after 3 seconds
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                const alerts = document.querySelectorAll('.alert-box:not(.error)'); // Exclude dynamic errors if any
                alerts.forEach(function (alert) {
                    alert.style.transition = 'opacity 0.5s ease';
                    alert.style.opacity = '0';
                    setTimeout(function () {
                        alert.remove();
                    }, 500);
                });
            }, 3000);
        });
    </script>
</body>

</html>